<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¿è§’å»ç•¸å˜</title>
    <style>
        /* --- æ ·å¼éƒ¨åˆ†ä¿æŒä¸å˜ --- */
        body { margin: 0; background-color: #1a1a1a; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        .container { display: flex; flex-direction: column; align-items: center; width: 100%; height: 100%; }
        #canvas-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; overflow: hidden; background: #000; background-image: linear-gradient(45deg, #222 25%, transparent 25%), linear-gradient(-45deg, #222 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #222 75%), linear-gradient(-45deg, transparent 75%, #222 75%); background-size: 20px 20px; }
        canvas { box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); max-width: 90%; max-height: 90%; }
        .controls { width: 100%; padding: 15px 20px; background: #2a2a2a; display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; border-top: 1px solid #444; }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 12px; color: #aaa; display: flex; justify-content: space-between; white-space: nowrap; }
        input[type="range"] { width: 100%; cursor: pointer; }
        .file-upload-group { grid-column: 1 / -1; display: flex; flex-direction: row; justify-content: center; gap: 20px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        .btn { background: #007bff; color: white; padding: 8px 20px; border-radius: 4px; text-align: center; cursor: pointer; font-size: 14px; border: none; display: flex; align-items: center; justify-content: center; min-width: 100px; }
        .btn:hover { filter: brightness(1.1); }
        .btn-save { background: #28a745; }
        #status { width: 100%; text-align: center; margin-top: 5px; font-size: 12px; color: #4caf50; height: 18px; }
        .divider { height: 1px; background: #444; grid-column: 1 / -1; margin: 5px 0; }
        .group-title { grid-column: 1 / -1; font-size: 14px; font-weight: bold; color: #ddd; margin-top: 5px; }
    </style>
</head>

<body>

    <div class="container">
        <div id="canvas-wrapper">
            <canvas id="glcanvas"></canvas>
        </div>

        <div class="controls">
            <div class="file-upload-group">
                <label class="btn">
                    ğŸ“‚ é€‰æ‹©ç…§ç‰‡
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                </label>
                <button id="saveBtn" class="btn btn-save">ğŸ’¾ ä¿å­˜å›¾ç‰‡</button>
            </div>
            <div id="status">è¯·ä¸Šä¼ ç…§ç‰‡å¼€å§‹</div>

            <div class="divider"></div>
            <div class="group-title">å‚ç›´æ–¹å‘å¼§åº¦è°ƒæ•´</div>

            <div class="control-group">
                <label>â¬†ï¸ ä¸Šè¾¹å¼§åº¦ (Top) <span id="val-top">0.0</span></label>
                <input type="range" id="c-top" min="-2.0" max="2.0" step="0.01" value="0.0">
            </div>
            <div class="control-group">
                <label>â¬‡ï¸ ä¸‹è¾¹å¼§åº¦ (Bottom) <span id="val-bottom">0.0</span></label>
                <input type="range" id="c-bottom" min="-2.0" max="2.0" step="0.01" value="0.0">
            </div>

            <div class="divider"></div>
            <div class="group-title">æ°´å¹³æ–¹å‘å¼§åº¦è°ƒæ•´</div>

            <div class="control-group">
                <label>â¬…ï¸ å·¦è¾¹å¼§åº¦ (Left) <span id="val-left">0.0</span></label>
                <input type="range" id="c-left" min="-2.0" max="2.0" step="0.01" value="0.0">
            </div>
            <div class="control-group">
                <label>â¡ï¸ å³è¾¹å¼§åº¦ (Right) <span id="val-right">0.0</span></label>
                <input type="range" id="c-right" min="-2.0" max="2.0" step="0.01" value="0.0">
            </div>

            <div class="divider"></div>

            <div class="control-group" style="grid-column: 1 / -1;">
                <label>ğŸ” å…¨å±€ç¼©æ”¾ (Zoom) <span id="val-scale">1.0</span></label>
                <input type="range" id="scale" min="0.5" max="5.0" step="0.01" value="1.0">
            </div>
        </div>
    </div>

    <script id="vs" type="x-shader/x-vertex">
    attribute vec2 a_position;
    attribute vec2 a_texCoord;
    varying vec2 v_texCoord;
    void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        v_texCoord = a_texCoord;
    }
    </script>

    <script id="fs" type="x-shader/x-fragment">
    precision mediump float;
    uniform sampler2D u_image;
    uniform float u_top;
    uniform float u_bottom;
    uniform float u_left;
    uniform float u_right;
    uniform float u_scale;
    varying vec2 v_texCoord;

    void main() {
        // 1. è·å–åŸå§‹å±å¹•åæ ‡ (-1.0 åˆ° 1.0)
        vec2 st = v_texCoord * 2.0 - 1.0;

        // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘å…ˆåº”ç”¨ç¼©æ”¾ï¼Œå¾—åˆ°â€œè™šæ‹Ÿå›¾ç‰‡åæ ‡â€
        // è¿™æ ·è®¡ç®—ç•¸å˜æ—¶ï¼Œæ˜¯åŸºäºå›¾ç‰‡ä¸Šçš„ä½ç½®ï¼Œè€Œä¸æ˜¯å±å¹•æ¡†çš„ä½ç½®
        vec2 scaledST = st / u_scale;

        // 3. åŸºäºç¼©æ”¾åçš„åæ ‡è®¡ç®—è·ç¦»çš„å¹³æ–¹
        float dx2 = scaledST.x * scaledST.x;
        float dy2 = scaledST.y * scaledST.y;

        // 4. æ ¹æ®åæ ‡æ­£è´Ÿé€‰æ‹©å¯¹åº”çš„ç•¸å˜ç³»æ•°
        float warpCoefY = (scaledST.y > 0.0) ? u_top : u_bottom;
        float warpCoefX = (scaledST.x > 0.0) ? u_right : u_left;

        // 5. è®¡ç®—ç•¸å˜å› å­ (åŸºäº scaledST)
        float factorX = 1.0 - warpCoefX * dy2;
        float factorY = 1.0 - warpCoefY * dx2;

        // 6. åº”ç”¨ç•¸å˜åˆ° scaledST
        vec2 distortedST = vec2(scaledST.x * factorX, scaledST.y * factorY);

        // 7. è½¬å› UV åæ ‡ (0.0 åˆ° 1.0)
        vec2 finalUV = (distortedST + 1.0) * 0.5;

        // 8. è¾¹ç•Œè£åˆ‡
        if (finalUV.x < 0.0 || finalUV.x > 1.0 || finalUV.y < 0.0 || finalUV.y > 1.0) {
            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
        } else {
            gl_FragColor = texture2D(u_image, finalUV);
        }
    }
    </script>

    <script>
        // --- JS é€»è¾‘ä¿æŒä¸å˜ ---
        const canvas = document.getElementById('glcanvas');
        const gl = canvas.getContext('webgl', { preserveDrawingBuffer: true });

        const inputs = {
            top: document.getElementById('c-top'),
            bottom: document.getElementById('c-bottom'),
            left: document.getElementById('c-left'),
            right: document.getElementById('c-right'),
            scale: document.getElementById('scale')
        };
        const imageInput = document.getElementById('imageInput');
        const saveBtn = document.getElementById('saveBtn');
        const statusDiv = document.getElementById('status');

        let program;
        let texture;

        if (!gl) { alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ WebGL"); }

        function createShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error(gl.getShaderInfoLog(shader));
                gl.deleteShader(shader); return null;
            }
            return shader;
        }

        function initWebGL() {
            const vsSource = document.getElementById('vs').text;
            const fsSource = document.getElementById('fs').text;
            const vertexShader = createShader(gl, gl.VERTEX_SHADER, vsSource);
            const fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fsSource);
            program = gl.createProgram();
            gl.attachShader(program, vertexShader);
            gl.attachShader(program, fragmentShader);
            gl.linkProgram(program);
            gl.useProgram(program);

            const vertices = new Float32Array([-1.0, -1.0, 0.0, 0.0, 1.0, -1.0, 1.0, 0.0, -1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0]);
            const buffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);

            const a_position = gl.getAttribLocation(program, "a_position");
            const a_texCoord = gl.getAttribLocation(program, "a_texCoord");
            gl.enableVertexAttribArray(a_position);
            gl.vertexAttribPointer(a_position, 2, gl.FLOAT, false, 4 * 4, 0);
            gl.enableVertexAttribArray(a_texCoord);
            gl.vertexAttribPointer(a_texCoord, 2, gl.FLOAT, false, 4 * 4, 2 * 4);
        }

        function loadImage(src) {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = function () {
                const maxWidth = window.innerWidth * 0.9;
                const maxHeight = window.innerHeight * 0.8;
                let width = img.width; let height = img.height;
                
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width *= ratio; height *= ratio;
                }
                
                canvas.width = width; canvas.height = height;
                gl.viewport(0, 0, canvas.width, canvas.height);

                if (texture) gl.deleteTexture(texture);
                texture = gl.createTexture();
                gl.bindTexture(gl.TEXTURE_2D, texture);

                gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);

                statusDiv.innerText = `å·²åŠ è½½: ${img.width}x${img.height}`;
                
                // é‡ç½®å‚æ•°æ—¶ï¼Œscale ä¿æŒä¸º 1.0
                Object.values(inputs).forEach(input => {
                    if (input.id !== 'scale') input.value = 0.0; else input.value = 1.0;
                    updateVal(input.id.replace('c-', ''), input.value);
                });
                render();
            };
            img.src = src;
        }

        function render() {
            if (!texture) return;
            const u_top = gl.getUniformLocation(program, "u_top");
            const u_bottom = gl.getUniformLocation(program, "u_bottom");
            const u_left = gl.getUniformLocation(program, "u_left");
            const u_right = gl.getUniformLocation(program, "u_right");
            const u_scale = gl.getUniformLocation(program, "u_scale");

            gl.uniform1f(u_top, parseFloat(inputs.top.value));
            gl.uniform1f(u_bottom, parseFloat(inputs.bottom.value));
            gl.uniform1f(u_left, parseFloat(inputs.left.value));
            gl.uniform1f(u_right, parseFloat(inputs.right.value));
            gl.uniform1f(u_scale, parseFloat(inputs.scale.value));

            gl.clearColor(0, 0, 0, 1);
            gl.clear(gl.COLOR_BUFFER_BIT);
            gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
        }

        function updateVal(id, val) {
            const displayId = id === 'scale' ? 'val-scale' : 'val-' + id;
            const el = document.getElementById(displayId);
            if (el) el.innerText = val;
        }

        Object.keys(inputs).forEach(key => {
            inputs[key].addEventListener('input', (e) => {
                updateVal(key, e.target.value);
                render();
            });
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                statusDiv.innerText = "æ­£åœ¨åŠ è½½...";
                const reader = new FileReader();
                reader.onload = (event) => loadImage(event.target.result);
                reader.readAsDataURL(file);
            }
        });

        saveBtn.addEventListener('click', () => {
            if (!texture) {
                alert("è¯·å…ˆä¸Šä¼ å›¾ç‰‡");
                return;
            }
            render();
            const dataURL = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[-:.]/g, "");
            link.download = `distort_fix_${timestamp}.png`;
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        initWebGL();
        Object.keys(inputs).forEach(key => updateVal(key, inputs[key].value));

    </script>
</body>
</html>